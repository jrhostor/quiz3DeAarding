<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1"
    />
    <title>Quiz</title>
  </head>
  <body>
    <div id="root"></div>

    <!-- Your app entry (Vite/React dev). In production this will point to the built JS file. -->
    <script type="module" src="/src/main.tsx"></script>

    <!-- Replit dev banner (OK to keep) -->
    <script src="https://replit.com/public/js/replit-dev-banner.js"></script>

    <!-- ✅ Post the height to the parent (Funnelish) so the iframe can auto-resize -->
<script>
  (function () {
    var last = 0;
    var ticking = false;
    var debounceId = null;

    function computeHeight() {
      // robust max across browsers
      return Math.max(
        document.documentElement.scrollHeight,
        document.body.scrollHeight,
        document.documentElement.offsetHeight,
        document.body.offsetHeight,
        document.documentElement.clientHeight
      );
    }

    function postHeight(force) {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(function () {
        ticking = false;
        var h = computeHeight();
        if (force || Math.abs(h - last) > 5) {
          last = h;
          window.parent.postMessage({ type: "quiz:height", value: h }, "*");
        }
      });
    }

    // Debounced notifier for DOM changes
    function schedulePost(force) {
      clearTimeout(debounceId);
      debounceId = setTimeout(function () { postHeight(!!force); }, 60);
    }

    // Initial + staged checks for hydration/fonts/images
    window.addEventListener("load", function () {
      postHeight(true);
      setTimeout(function(){ postHeight(true); }, 120);
      setTimeout(function(){ postHeight(true); }, 300);
      setTimeout(function(){ postHeight(true); }, 800);
    });

    // On resize (e.g., mobile rotation / keyboard)
    window.addEventListener("resize", function () { schedulePost(false); });

    // On DOM mutations (route changes, expanding answers, etc.)
    new MutationObserver(function () { schedulePost(false); }).observe(document.body, {
      childList: true, subtree: true, attributes: true, characterData: true
    });
  })();

  (function () {
    function requestParentScroll() {
      if (document.activeElement) document.activeElement.blur();
      window.parent.postMessage({ type: "quiz:scrollToTop" }, "*");
    }

    // Heuristics for "Next" controls; adjust selectors to your markup if needed
    document.addEventListener("click", function (e) {
      var el = e.target && e.target.closest('button, [role="button"], .btn, .button, [data-next], [data-action="next"]');
      if (!el) return;

      var txt = (el.innerText || el.textContent || "").trim().toLowerCase();
      var looksLikeNext =
        /^(next|continue|proceed|volgende|siguiente|weiter)$/.test(txt) ||
        /next|continue|proceed|volgende|siguiente|weiter/.test(txt) ||
        el.id === "next" ||
        el.classList.contains("next") ||
        el.dataset.next === "true" ||
        el.getAttribute("data-action") === "next";

      if (looksLikeNext) {
        // wait one tick for the new question to render
        setTimeout(requestParentScroll, 80);
      }
    }, true);
  })();
  
  (function () {
    // helper: ask parent (Funnelish) to scroll to top of the quiz block
    function requestParentScrollToTop() {
      // blur to close mobile keyboards so scroll isn't blocked
      if (document.activeElement) document.activeElement.blur();
      window.parent.postMessage({ type: "quiz:scrollToTop" }, "*");
    }

    // 1) Event delegation: when ANY button that looks like "Next" is clicked
    document.addEventListener("click", function (e) {
      var el = e.target;
      if (!(el instanceof Element)) return;

      // find the nearest button-like element
      var btn = el.closest('button, [role="button"], .btn, .button');
      if (!btn) return;

      // heuristics: text contains "next" (case-insensitive) or has a known class/id
      var txt = (btn.innerText || btn.textContent || "").trim().toLowerCase();
      var isNext =
        /^(next|continue|proceed|volgende)$/.test(txt) ||      // exact words
        /next|continue|proceed|volgende/.test(txt) ||          // substring
        btn.id === "next" || btn.classList.contains("next") || // common hooks
        btn.dataset.next === "true";

      if (isNext) {
        // wait a tick for your app to render the next question, then request scroll
        setTimeout(requestParentScrollToTop, 80);
      }
    }, true);

    // 2) Fallback: if your quiz updates the DOM without a button (auto-advance),
    // watch for big DOM changes and request scroll once.
    var lastMutation = 0;
    var mo = new MutationObserver(function (mutations) {
      var now = Date.now();
      // throttle so we don't spam on heavy renders
      if (now - lastMutation < 150) return;
      lastMutation = now;
      // Heuristic: when many nodes change, it’s likely a new question
      var changed = 0;
      for (var i = 0; i < mutations.length; i++) {
        changed += (mutations[i].addedNodes ? mutations[i].addedNodes.length : 0);
      }
      if (changed > 3) {
        setTimeout(requestParentScrollToTop, 80);
      }
    });
    mo.observe(document.body, { childList: true, subtree: true });

    // (You already have the height postMessage script in this page; keep it as is.)
  })();
</script>
  </body>
</html>
